<meta property="og:url" content="https://www.your-domain.com/your-page.html" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Your Website Title" />
<meta property="og:description" content="Your description" />
<meta property="og:image" content="https://www.your-domain.com/path/image.jpg" />
<link rel="stylesheet" type="text/css" href="./../../common/ckeditor/styles.css">
<style>
    .profile-header-container {
        margin: 0 auto;
        text-align: center;
    }
    
    .profile-header-img>img.img-circle {
        border: 2px solid #51D2B7;
    }
    
    .rank-label-container {
        margin-top: -19px;
        /* z-index: 1000; */
        text-align: center;
    }
    
    .label.label-default.rank-label {
        background-color: rgb(81, 210, 183);
        border-radius: 27px;
    }
    
    body {
        font: 16px Arial;
    }
    /*the container must be positioned relative:*/
    
    .autocomplete {
        position: relative;
        /* display: inline-block; */
    }
    
    input {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        padding: 10px;
        font-size: 16px;
    }
    
    input[type=text] {
        background-color: #f1f1f1;
        width: 100%;
    }
    
    input[type=submit] {
        background-color: DodgerBlue;
        color: #fff;
        cursor: pointer;
    }
    
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        /*position the autocomplete items to be the same width as the container:*/
        top: 100%;
        left: 0;
        right: 0;
    }
    
    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }
    /*when hovering an item:*/
    
    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }
    /*when navigating through the items using the arrow keys:*/
    
    .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
    }
    
    #question-description>p>img {
        width: 100%;
    }
    
    .container-description>p>img {
        width: 100%;
    }
    
    #question-description>figure>img {
        width: 100%;
    }
    
    figure>img {
        width: 100%;
    }
    
    pre {
        background: hsla(0, 0%, 78%, .3);
        border: 1px solid #c4c4c4;
        border-radius: 2px;
        color: #353535;
        direction: ltr;
        font-style: normal;
        min-width: 200px;
        padding: 1em;
        tab-size: 4;
        text-align: left;
        white-space: pre-wrap;
    }
    
    .unread {
        background-color: #bd511e !important;
        color: white;
    }
    
    .unread small {
        color: white;
    }
    
    .unread a {
        color: white;
    }
</style>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v17.0" nonce="z2fQyic9"></script>
<div class="container mt-3 mb-5">
    <!-- Question Card -->
    <div class="row">
        <div class="col">
            <div class="card shadow-sm p-2">
                <div class="card-body" id="login-form">
                    <div id="card-form">
                        <!-- User Info -->
                        <div class="row py-3 align-items-center">
                            <div class="col-lg-1 order-lg-1 order-2 col-12 pl-4 pt-0 mt-0 mb-lg-0 mb-3 text-center">
                                <img loading="lazy" class="img-profile img-circle rounded-circle" style="width:60px; height: 60px;" src="./../../resource/profile/default.svg" id="question-picture">
                            </div>
                            <div class="col-lg-7 order-lg-2 order-3">
                                <div class="row mb-2">
                                    <div class="col-lg-9 col-12">
                                        <h6><b id="question-user-name"></b></h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <small class="text-muted" id="question-subject"></small> <small class="text-muted"> Â· </small> <small class="text-muted" id="question-date"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 ml-auto order-lg-3 order-1">
                                <div class="row mb-3">
                                    <div class="col-9 text-right" id="question-status"></div>
                                    <div class="col-1 text-right login-user">
                                        <div class="btn-group d-flex flex-row-reverse dropright">
                                            <i class="fa fa-solid fa-ellipsis-v pl-5" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></i>
                                            <div class="dropdown-menu">
                                                <button class="dropdown-item for-non-creator for-non-creator-report-question" type="button" data-toggle="modal" data-target="#modal-report-question"><i class="fa fa-flag fa-sm"></i> Report</button>
                                                <button class="dropdown-item for-creator for-creator-edit-question" data-toggle="modal" data-target="#modal-edit-question" type="button"><i class="fa fa-pen fa-sm text-success"></i> Edit Question</button>
                                                <button class="dropdown-item for-creator for-creator-delete-question" data-toggle="modal" data-target="#modal-delete-question" type="button"><i class="fa fa-trash fa-sm text-danger"></i> Delete Question</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Question Title -->
                        <div class="row ml-1 mt-3 mb-0">
                            <div class="col">
                                <b><p class="mb-0" id="question-title"></p></b>
                            </div>
                        </div>
                        <!-- Question Description -->
                        <div class="row ml-1 mt-3">
                            <div class="col">
                                <p class="mb-0" id="question-description" style="white-space: pre-line; tab-size: 8;"></p>
                                <div class="mt-4 attachment-link-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Card -->
    <div class="row mt-3">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div id="card-form">
                        <div class="login-user">
                            <!-- Answer Form -->
                            <form class="" id="form-answer-now">
                                <div class="row">
                                    <div class="col">
                                        <textarea class="form-control" name="" placeholder="Enter your answer here..." id="textarea-answer" required maxlength="1000"></textarea>
                                    </div>
                                </div>
                                <div class="row mt-2 justify-content-end">
                                    <div class="col-auto p-2">
                                        <a href="#answer-now" id="btn-answer-now" class="btn btn-success btn-sm">Use Text Editor <i class="fa fa-edit"></i></a>
                                    </div>
                                    <div class="col-auto p-2">
                                        <button type="submit" class="btn btn-primary btn-sm">Answer Now <i class="fa fa-paper-plane"></i></button>
                                    </div>
                                </div>
                            </form>
                            <hr class="sidebar-divider mt-4">
                        </div>
                        <!-- Answers Section -->
                        <h5 class="mb-4"><b>Answers</b></h5>
                        <div id="container-answers"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-edit-question" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Question</h5>
            </div>
            <form id="form-edit-question" class="needs-validation container">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label align-middle pr-2 pt-2" for="input-edit-question-title">Title</label>
                            <input type="text" id="input-edit-question-title" class="form-control" placeholder="Enter title" required/>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label align-middle pr-2 pt-2" for="input-edit-question-subject">Subject</label>
                            <select class="form-control" id="input-edit-question-subject">
                                <!-- Add your subject options here -->
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label align-middle pr-2 pt-2" for="input-edit-question-status">Status</label>
                            <select class="form-control" id="input-edit-question-status">
                                <option value="1">Unanswered</option>
                                <option value="2">Answered</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label align-middle pr-2 pt-2" for="input-edit-question-attachment">Attachment</label>
                            <input type="file" name="attachment" class="form-control" id="input-edit-question-attachment">
                            <div class="mt-3 attachment-link-container"></div>
                        </div>
                    </div>
                    <div class="form-outline mb-3 ml-3 mt-4 mr-3">
                        <div class="w-100">
                            <div class="row row-editor">
                                <div class="editor-container">
                                    <div id="editor-edit-question"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">Close</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-delete-question" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Are you sure do yo want to delete this question?</h5>
            </div>
            <form id="form-add-question" class="needs-validation">
                <div class="modal-body">
                    <div class="form-outline mb-2">
                        <label class="form-label" for="input-">Title:</label>
                        <p id="question-delete-title"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">No</button>
                    <button type="button" id="button-delete-question" class="btn btn-danger">Yes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-report-question" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: black !important">Report a Question</h5>
            </div>
            <form id="form-report-question" class="needs-validation">
                <div class="modal-body">
                    <div class="form-group form-outline mb">
                        <select class="form-control dropdown" id="input-report-detail">
                            <option value="">--Please Select Reason--</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="hate_speech">Hate Speech or Offensive Content</option>
                            <option value="harassment">Harassment or Bullying</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="intellectual_property">Violation of Intellectual Property</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">Close</button>
                    <button type="submit" class="btn btn-primary">Report</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-edit-answer" tabindex="-1" role="dialog" aria-labelledby="modal-edit-answer-title" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-edit-answer-title">Edit Answer</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="form-edit-answer" class="needs-validation">
                <div class="modal-body">
                    <div class="container">
                        <div class="form-outline mb-3">
                            <div class="row row-editor">
                                <div class="editor-container">
                                    <div id="editor-edit-answer"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="attachment">Attachment</label>
                            <input type="file" class="form-control-file" id="attachment" name="attachment">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="button-close">Close</button>
                    <button type="button" id="button-edit-answer" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-delete-answer" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Are you sure do yo want to delete this answer?</h5>
            </div>
            <form id="form-add-question" class="needs-validation">
                <div class="modal-body">
                    <div class="form-outline mb-2">
                        <label class="form-label" for="input-">Title:</label>
                        <p id="answer-delete-title"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">No</button>
                    <button type="button" id="button-delete-answer" class="btn btn-danger">Yes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-report-answer" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report an Answer</h5>
            </div>
            <form id="form-report-answer" class="needs-validation">
                <div class="modal-body">
                    <div class="form-group form-outline mb">
                        <select class="form-control dropdown" id="input-report-answer">
                            <option value="">--Please Select Reason--</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="hate_speech">Hate Speech or Offensive Content</option>
                            <option value="harassment">Harassment or Bullying</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="intellectual_property">Violation of Intellectual Property</option>
                        </select>
                        <!-- <textarea class="form-control" id="input-report-answer" rows="7" placeholder="Enter why are you reporting this answer..."></textarea> -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">Close</button>
                    <button type="button" id="button-report-answer" class="btn btn-primary">Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        var questionID = window.location.search.substring(1).split("=")[1];
        var userID;
        var creatorID;
        getUserProfile();
        getSubjectList();

        if (isGuest) {
            $(".login-user").addClass("d-none");
        }

        var inputField = document.getElementById('textarea-answer');
        inputField.onkeydown = function(e) {
            if (e.keyCode === 9) {
                this.setRangeText(
                    '\t',
                    this.selectionStart,
                    this.selectionStart,
                    'end'
                );
                return false;
            }
        }

        $("#btn-answer-now").click(function() {
            $("#main-container").load('./form-answer-now.html');
        });

        $("#form-answer-now").on('submit', function(event) {
            event.preventDefault();
            var answer = $("#textarea-answer").val();
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'save-answer',
                    questionID: questionID,
                    answer: answer,
                    creatorID: creatorID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        $("#textarea-answer").val("");
                        retrieveForumDetails();
                        retrieveForumAnswers();
                        swalSuccessNotification("Answer has been successfully posted.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        });

        $("#form-report-question").on('submit', function() {
            event.preventDefault();
            var detail = $("#input-report-detail").val();
            report(questionID, detail, 1);
        });

        $("#button-report-answer").on('click', function() {
            var answerID = $(this).data('id');
            var detail = $("#input-report-answer").val();
            if ($(this).data("type") == 1) {
                report(answerID, detail, 2);
            } else if ($(this).data("type") == 2) {
                report(answerID, detail, 3);
            }
        });

        function report(id, detail, type) {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'report',
                    detail: detail,
                    id: id,
                    type: type
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        if (type == 1) {
                            $("#modal-report-question").modal('toggle');
                            $("#main-container").load('./form-forum.html');
                        } else if (type == 2 || type == 3) {
                            $("#modal-report-answer").modal('toggle');
                        }
                        swalSuccessNotification("Report has been successfully submitted.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        $("#button-edit-answer").on('click', function() {
            var answerID = $(this).data('id');
            if ($(this).data('type') == 1) {
                updateAnswer(answerID);
            } else if ($(this).data('type') == 2) {
                updateReply(answerID);
            }
        });

        function updateAnswer(answerID) {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'update-answer',
                    description: getEditorData("editor-edit-answer"),
                    answerID: answerID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumAnswers();
                        $("#modal-edit-answer").modal('toggle');
                        swalSuccessNotification("Your answer has been successfully updated.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function updateReply(replyID) {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'update-reply',
                    description: getEditorData("editor-edit-answer"),
                    replyID: replyID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumAnswers();
                        $("#modal-edit-answer").modal('toggle');
                        swalSuccessNotification("Your answer has been successfully updated.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        $("#form-edit-question").on('submit', function(event) {
            event.preventDefault();

            var formData = new FormData(this);
            var fileInput = document.getElementById('input-edit-question-attachment');
            var file = fileInput.files[0];

            if (file) {
                if (!validFileSize(file)) {
                    return;
                } else {
                    formData.append('attachment', file);
                }
            }

            formData.append('action', 'update-question');
            formData.append('title', $("#input-edit-question-title").val());
            formData.append('description', getEditorData("editor-edit-question"));
            formData.append('questionID', questionID);
            formData.append('subject', $("#input-edit-question-subject").val());
            formData.append('status', $("#input-edit-question-status").val());

            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumDetails();
                        $("#modal-edit-question").modal('toggle');
                        swalSuccessNotification("Your question has been successfully updated.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                },
                complete: function() {
                    console.log('Request is complete');
                }
            });
        });

        function retrieveForumDetails() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-question-detail',
                    questionID: questionID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        console.log(dataResult);
                        var question = dataResult.question;
                        var picture = question['picture'];
                        var status;
                        var description = question['description'];
                        var subjectName = question['subject'];
                        var attachment = question['fileName'];
                        if (picture == "") {
                            picture = "./../../resource/profile/default.svg";
                        } else {
                            picture = "./../../resource/profile/" + picture;
                        }

                        if (question['status'] == 1) {
                            status = "<span class='border bg-danger status-danger rounded py-1 px-3 text-white'>Unanswered</span>";
                        } else if (question['status'] == 2) {
                            status = "<span class='border bg-success status-success rounded py-1 px-3 text-white'>Answered</span>";
                        }
                        if (userID == question.studentID) {
                            $(".for-non-creator").addClass("d-none");
                        } else {
                            $(".for-creator").addClass("d-none");
                        }

                        if (attachment) {
                            // Display a link to download the attachment
                            var downloadLink = $("<a>")
                                .attr("href", "./../../resource/attachment/" + attachment)
                                .attr("download", attachment)
                                .text("Download Attachment: " + attachment);
                            // Append the download link to the specified container
                            $(".attachment-link-container").empty().append(downloadLink);
                        } else {
                            // If there is no attachment, clear the container
                            $("#attachment-link-container").empty();
                        }

                        creatorID = question.studentID;

                        $("#question-picture").attr("src", picture);
                        $("#question-user-name").html(question.name);
                        $("#question-status").html(status);
                        $("#question-date").html(convertTo12HourFormat(question.creationDateTime));
                        $("#question-subject").html(question.subject);
                        $("#question-subject").data('id', question.subjectID);
                        $("#question-title").html(question.title);
                        $("#question-delete-title").html(question.title);
                        $("#question-description").html(question.description);
                        $("#input-edit-question-title").val(question.title);
                        initEditor("editor-edit-question", question.description, "Enter description here...");
                        $("#input-edit-question-subject").val(question.subjectID).change();
                        $("#input-edit-question-status").val(question.status).change();
                    }


                    $(".for-creator-edit-question").on("click", function(e) {
                        var answerID = $(this).data("id");
                        var answer = $("#question-" + $(this).data("id")).html();
                        $("#input-edit-question-title").val($("#question-title").html());
                        $("#input-edit-question-subject").val($("#question-subject").data("id")).change();
                    });

                    $(".for-creator-delete-question").on("click", function(e) {
                        // alert(questionID);
                    });

                    $(".for-non-creator-report-question").on("click", function(e) {
                        // alert($(this).data("id"));
                    });
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function retrieveForumAnswers() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-answers',
                    questionID: questionID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        // Sort the answer list based on correctAnswer
                        dataResult.answerList.sort((a, b) => {
                            if (a.correctAnswer && !b.correctAnswer) {
                                return -1; // a comes before b
                            } else if (!a.correctAnswer && b.correctAnswer) {
                                return 1; // b comes before a
                            } else {
                                return 0; // no change in order
                            }
                        });

                        var answerList = "";
                        dataResult.answerList.forEach(answer => {
                            var answerID = answer.answerID;
                            var studentID = answer.studentID;
                            var questionerID = answer.questionerID;
                            var text = answer.answer;
                            var picture = answer.picture;
                            var replies = "";
                            var creationDateTime = convertTo12HourFormat(answer.creationDateTime);
                            if (picture == "") {
                                picture = "./../../resource/profile/default.svg";
                            } else {
                                picture = "./../../resource/profile/" + picture;
                            }

                            if (answer.replies != null && answer.replies != "") {
                                answer.replies.forEach(reply => {
                                    var replyPicture = reply.picture;
                                    if (replyPicture == "") {
                                        replyPicture = "./../../resource/profile/default.svg";
                                    } else {
                                        replyPicture = "./../../resource/profile/" + replyPicture;
                                    }

                                    var menu;
                                    if (userID == reply.studentID) {
                                        menu = `<button class="dropdown-item for-creator-edit-reply" type="button" data-id="${reply.replyID}" data-toggle="modal" data-target="#modal-edit-answer"><i class="fa fa-pencil fa-sm text-success"></i> Edit Answer</button>
                                        <button class="dropdown-item for-creator-delete-reply" type="button" data-id="${reply.replyID}" data-toggle="modal" data-target="#modal-delete-answer" id=""><i class="fa fa-trash fa-sm text-danger"></i> Delete Answer</button>`;
                                    } else {
                                        menu = `<button class="dropdown-item for-non-creator-reply-report" type="button" data-id="${reply.replyID}" data-toggle="modal" data-target="#modal-report-answer" id=""><i class="fa fa-flag fa-sm"></i> Report</button>`;
                                    }

                                    replies += populateReplyRow(
                                        reply.replyID,
                                        replyPicture,
                                        reply.name,
                                        reply.status,
                                        convertTo12HourFormat(reply.creationDateTime),
                                        getYearLevel(reply.yearLevel),
                                        reply.answer,
                                        menu,
                                        reply.specialization,
                                        reply.studentID);
                                });
                                replies = `<hr class="sidebar-divider my-2">
                                                <div class="ml-lg-5 ml-2 my-4">
                                                    <div class="row">
                                                        <div class="col">
                                                            <b><span class="text-primary">Comments</span></b>
                                                        </div>
                                                    </div>
                                                    ${replies}
                                                </div>`
                            }

                            var menu;
                            var hasRateButton = false;
                            if (userID == studentID) {
                                menu = `<button class="dropdown-item for-creator-edit-answer" type="button" data-id="${answerID}" data-toggle="modal" data-target="#modal-edit-answer" id=""><i class="fa fa-pencil fa-sm text-success"></i> Edit Answer</button>
                                        <button class="dropdown-item for-creator-delete-answer" type="button" data-id="${answerID}" data-toggle="modal" data-target="#modal-delete-answer" id=""><i class="fa fa-trash fa-sm text-danger"></i> Delete Answer</button>`;
                            } else {
                                menu = `<button class="dropdown-item for-non-creator-report-answer" type="button" data-id="${answerID}" data-toggle="modal" data-target="#modal-report-answer" id=""><i class="fa fa-flag fa-sm"></i> Report</button>`;
                                hasRateButton = true;
                            }

                            var attachment = "";
                            if (answer.fileName != null && answer.fileName != "") {
                                attachment = `<a href="./../../resource/attachment/${answer.fileName}" download="${answer.fileName}">Download Attachment: ${answer.fileName}</a>`;
                            }

                            var markAsCorrect = "";


                            if (questionerID == userID) {
                                if (userID != studentID) {
                                    markAsCorrect = `<div class="btn-group-toggle mb-2" data-toggle="buttons">
                                                    <label class="btn btn-outline-success mark-correct-answer">
                                                        <input type="checkbox" name="correctAnswer" autocomplete="off" data-id="${answerID}" data-questionID="${questionID}" class="mark-correct-input"> Mark as Correct Answer
                                                        <i class="fas fa-check"></i>
                                                    </label>
                                                </div>`;
                                    if (answer.correctAnswer) {
                                        markAsCorrect = `<div class="btn-group-toggle mb-2" data-toggle="buttons">
                                                    <label class="btn btn-outline-danger mark-correct-answer active">
                                                        <input type="checkbox" name="correctAnswer" autocomplete="off" data-id="${answerID}" data-questionID="${questionID}" class="mark-correct-input" checked> Unmark as Correct Answer
                                                        <i >&#10006;</i>
                                                    </label>
                                                </div>`;
                                    }
                                }
                            } else {
                                if (answer.correctAnswer) {
                                    markAsCorrect = `<div class="btn-group-toggle mb-2" data-toggle="buttons">
                                                    <label class="btn btn-outline-success mark-correct-answer active">
                                                        <input type="checkbox" name="correctAnswer" autocomplete="off" disabled data-id="${answerID}" data-questionID="${questionID}" class="mark-correct-input" checked> Correct Answer
                                                        <i class="fas fa-check"></i>
                                                    </label>
                                                </div>`;
                                }
                            }


                            answerList += populateAnswerRow(
                                answerID,
                                picture,
                                answer.name,
                                status,
                                convertTo12HourFormat(answer.creationDateTime),
                                getYearLevel(answer.yearLevel),
                                text,
                                replies,
                                getRatingID(answer.rating),
                                getRating(answer.rating, 1),
                                getRating(answer.rating, -1),
                                hasUserRating(answer.rating, 1, userID),
                                hasUserRating(answer.rating, -1, userID),
                                menu,
                                hasRateButton,
                                answer.specialization,
                                answer.studentID,
                                attachment,
                                markAsCorrect
                            );

                        });
                    } else {
                        answerList = populateEmptyRow("No Answer");
                    }
                    $("#container-answers").html(answerList);

                    if (isGuest) {
                        $(".login-user").addClass("d-none");
                    }

                    $(".mark-correct-input").on("change", function() {
                        $(this).closest(".btn").toggleClass("btn-outline-success btn-success");
                        var id = $(this).data("id");
                        var questionID = $(this).data("questionid");
                        if ($(this).is(":checked")) {
                            Swal.fire({
                                title: 'Are you sure?',
                                text: 'Do you want to mark this as the correct answer?',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes',
                                cancelButtonText: 'No'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Call the function to mark the answer as correct
                                    markAsCorrectFunction(questionID, id, true); // Replace this with your actual function
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Are you sure?',
                                text: 'Do you want to unmark this as the correct answer?',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes',
                                cancelButtonText: 'No'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Call the function to mark the answer as correct
                                    markAsCorrectFunction(questionID, id, false); // Replace this with your actual function
                                }
                            });
                        }
                    });

                    function markAsCorrectFunction(questionID, id, markAsCorrect) {
                        $.ajax({
                            url: "../../common/db.php",
                            type: "POST",
                            data: {
                                action: 'mark-as-correct-answer',
                                answerID: id,
                                questionID: questionID,
                                markAsCorrect: markAsCorrect
                            },
                            cache: false,
                            success: function(dataResult) {
                                var dataResult = JSON.parse(dataResult);
                                if (dataResult.statusCode == 200) {
                                    retrieveForumDetails();
                                    retrieveForumAnswers();
                                    if (markAsCorrect) {
                                        swalSuccessNotification("The answer has been successfully marked as the correct answer.");
                                    } else {
                                        swalSuccessNotification("The answer has been successfully unmarked as the correct answer.");
                                    }
                                } else {
                                    swalErrorNotification();
                                }
                            },
                            beforeSend: function() {
                                // Code to be executed before the request is sent
                                console.log('Request is about to be sent');
                            },
                            error: function(xhr, status, error) {
                                // Code to be executed if there is an error
                                console.error('Error:', error);
                            },
                            complete: function() {
                                // Code to be executed after the request is complete (success, error, or abort)
                                console.log('Request is complete');
                            }
                        });
                    }

                    $(".button-reply").on('click', function() {
                        if ($("#container-reply-" + this.id).hasClass("d-none")) {
                            $("#container-reply-" + this.id).removeClass("d-none");
                        } else {
                            $("#container-reply-" + this.id).addClass("d-none");
                        }
                    });

                    $(".for-creator-edit-answer").on("click", function(e) {
                        var answerID = $(this).data("id");
                        initEditor("editor-edit-answer", $("#answer-" + answerID).html(), "Enter your answer here...");
                        $("#button-edit-answer").data("id", answerID);
                        $("#button-edit-answer").data("type", 1);
                    });

                    $(".for-creator-delete-answer").on("click", function(e) {
                        var answerID = $(this).data("id");
                        $("#answer-delete-title").html($("#answer-" + answerID).html());
                        $("#button-delete-answer").data("id", answerID);
                        $("#button-delete-answer").data("type", 1);
                    });

                    $(".for-non-creator-report-answer").on("click", function(e) {
                        var answerID = $(this).data("id");
                        $("#button-report-answer").data("id", answerID);
                        $("#button-report-answer").data("type", 1);
                    });

                    $(".button-answer-reply").on("click", function() {
                        var answerID = this.id;
                        var reply = $("#textarea-reply-" + answerID).val();
                        saveReply(answerID, reply);
                    });

                    $(".for-creator-edit-reply").on('click', function() {
                        var answerID = $(this).data("id");
                        initEditor("editor-edit-answer", $("#reply-" + answerID).html(), "Enter your answer here...");
                        $("#button-edit-answer").data("id", answerID);
                        $("#button-edit-answer").data("type", 2);
                    });

                    $(".for-creator-delete-reply").on('click', function() {
                        var answerID = $(this).data("id");
                        $("#answer-delete-title").html($("#reply-" + answerID).html());
                        $("#button-delete-answer").data("id", answerID);
                        $("#button-delete-answer").data("type", 2);
                    });

                    $(".for-non-creator-reply-report").on('click', function() {
                        var answerID = $(this).data("id");
                        $("#button-report-answer").data("id", answerID);
                        $("#button-report-answer").data("type", 2);
                    });

                    $(".btn-thumbs-up").on("click", function() {
                        var answerID = $(this).data("id");
                        var value = $(this).data("value");
                        var isSelected = $(this).data("selected");
                        var ratingID = $(this).data("ratingid");
                        var accountID = $(this).data("accountid");

                        // Uncheck
                        if ($(this).hasClass("btn-primary")) {
                            if (isSelected) {
                                value = value - 1;
                            }
                            setRating(answerID, ratingID, 0, accountID);
                            $(this).removeClass("btn-primary");
                            $('#btn-thumbs-up-icon-' + answerID).removeClass("text-white");
                            $('#btn-thumbs-up-icon-' + answerID).addClass("text-primary");
                        } else {
                            if (!isSelected) {
                                value += 1;
                            }
                            setRating(answerID, ratingID, 1, accountID);
                            uncheckedThumbsDown(answerID);
                            $(this).addClass("btn-primary");
                            $('#btn-thumbs-up-icon-' + answerID).removeClass("text-primary");
                            $('#btn-thumbs-up-icon-' + answerID).addClass("text-white");
                        }
                        $('#btn-thumbs-up-value-' + answerID).text(value);
                    });

                    $(".btn-thumbs-down").on("click", function() {
                        var isSelected = $(this).data("selected");
                        var answerID = $(this).data("id");
                        var value = $(this).data("value");
                        var ratingID = $(this).data("ratingid");
                        var accountID = $(this).data("accountid");
                        // Unchecked
                        if ($(this).hasClass("btn-danger")) {
                            if (isSelected) {
                                value = value - 1;
                            }
                            setRating(answerID, ratingID, 0, accountID);
                            $(this).removeClass("btn-danger");
                            $('#btn-thumbs-down-icon-' + answerID).removeClass("text-white");
                            $('#btn-thumbs-down-icon-' + answerID).addClass("text-danger");
                        } else {
                            if (!isSelected) {
                                value += 1;
                            }
                            setRating(answerID, ratingID, -1, accountID);
                            uncheckedThumbsUp(answerID);
                            $(this).addClass("btn-danger");
                            $('#btn-thumbs-down-icon-' + answerID).removeClass("text-danger");
                            $('#btn-thumbs-down-icon-' + answerID).addClass("text-white");
                        }
                        $('#btn-thumbs-down-value-' + answerID).text(value);
                    });

                    $(".card-row").hover(
                        function() {
                            var id = "";
                            if (this.id.includes("row-reply-")) {
                                id = this.id.split("-")[2];
                                $("#ellipsis-reply-" + id).show();
                            } else if (this.id.includes("row-answer-")) {
                                id = this.id.split("-")[2];
                                $("#ellipsis-answer-" + id).show();
                            }
                        },
                        function() {
                            var id = "";
                            if (this.id.includes("row-reply-")) {
                                id = this.id.split("-")[2];
                                $("#ellipsis-reply-" + id).hide();
                            } else if (this.id.includes("row-answer-")) {
                                id = this.id.split("-")[2];
                                $("#ellipsis-answer-" + id).hide();
                            }
                        },
                    );


                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function getSubjectList() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-active-subject-list'
                },
                cache: false,
                success: function(dataResult) {
                    var subjectOptions = "";
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        subjectList = dataResult.subjectList;
                        dataResult.subjectList.forEach(subject => {
                            subjectOptions += "<option value='" + subject['subjectID'] + "'>" + subject['subject'] + "</option>";
                        });
                    }
                    $("#input-edit-question-subject").html($("#input-edit-question-subject").html() + subjectOptions);
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        $("#button-delete-question").on('click', function() {
            deleteQuestion();
        });

        $("#button-delete-answer").on('click', function() {
            if ($(this).data("type") == 1) {
                deleteAnswer($(this).data('id'));
            } else if ($(this).data("type") == 2) {
                deleteReply($(this).data('id'));
            }
        });

        function deleteQuestion() {
            $("#modal-delete-question").modal('toggle');
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'delete-question',
                    questionID: questionID,
                    status: 0
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        swalSuccessNotification("Your question has been successfully deleted.");
                        $("#main-container").load('./form-forum.html');
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function deleteAnswer(answerID) {
            $("#modal-delete-answer").modal('toggle');
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'delete-answer',
                    answerID: answerID,
                    status: 0
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumAnswers();
                        swalSuccessNotification("Your answer has been successfully updated.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function deleteReply(replyID) {
            $("#modal-delete-answer").modal('toggle');
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'delete-reply',
                    replyID: replyID,
                    status: 0
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumAnswers();
                        swalSuccessNotification("Your comment has been successfully updated.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function uncheckedThumbsDown(answerID) {
            var buttonID = "#btn-thumbs-down-" + answerID;
            var isSelected = $(buttonID).data("selected");
            var answerID = $(buttonID).data("id");
            var value = $(buttonID).data("value");
            var ratingID = $(buttonID).data("ratingid");

            if ($(buttonID).hasClass("btn-danger")) {
                if (isSelected) {
                    value = value - 1;
                }
                $(buttonID).removeClass("btn-danger");
                $('#btn-thumbs-down-icon-' + answerID).removeClass("text-white");
                $('#btn-thumbs-down-icon-' + answerID).addClass("text-danger");
                $('#btn-thumbs-down-value-' + answerID).text(value);
            }
        }

        function uncheckedThumbsUp(answerID) {
            var buttonID = "#btn-thumbs-up-" + answerID;
            var value = $(buttonID).data("value");
            var isSelected = $(buttonID).data("selected");
            var ratingID = $(buttonID).data("ratingid");

            if ($(buttonID).hasClass("btn-primary")) {
                if (isSelected) {
                    value = value - 1;
                }
                $(buttonID).removeClass("btn-primary");
                $('#btn-thumbs-up-icon-' + answerID).removeClass("text-white");
                $('#btn-thumbs-up-icon-' + answerID).addClass("text-primary");
                $('#btn-thumbs-up-value-' + answerID).text(value);
            }

        }

        function getUserProfile() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-user-profile'
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        if (dataResult.userType == "1") {
                            userID = dataResult.studentInformation.studentID;
                        } else if (dataResult.userType == "3") {
                            userID = dataResult.specialAccountInformation.accountID;
                        }
                        retrieveForumDetails();
                        retrieveForumAnswers();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function setRating(answerID, ratingID, rating, accountID) {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'set-rating',
                    answerID: answerID,
                    ratingID: ratingID,
                    rating: rating,
                    accountID: accountID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        console.log("Success");
                        $("#btn-thumbs-up-" + answerID).data("ratingid", dataResult.ratingID);
                        $("#btn-thumbs-down-" + answerID).data("ratingid", dataResult.ratingID);
                    } else {
                        console.log("Something wen't wrong, please try again later!");
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }

        function getRating(ratings, status) {
            var length = ratings.filter(function(rating) {
                return rating.rating == status;
            }).length;
            return length;
        }

        function getRatingID(ratings) {
            var rating = ratings.find(function(rating) {
                return rating.studentID == userID;
            });
            if (rating != null) {
                return rating.ratingID;
            }
        }

        function hasUserRating(ratings, status, userID) {
            console.log("THIS IS RATINGS");
            console.log(ratings);
            console.log(status);
            var length = ratings.filter(function(rating) {
                return rating.studentID == userID && rating.rating == status;
            }).length;

            console.log(length);
            console.log("END OF RATINGS ------------------------");
            return length > 0;
        }


        function saveReply(answerID, response) {
            // if (response.trim() !== '') {
            //     // If the comment box is not filled, show an error message
            //     Swal.fire({
            //         icon: 'error',
            //         title: 'Error',
            //         text: 'Please fill out the comment box before posting.'
            //     });
            //     return;
            // }

            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'save-reply',
                    answerID: answerID,
                    questionID: questionID,
                    response: response,
                    creatorID: creatorID
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        retrieveForumAnswers();
                        swalSuccessNotification("Your comment has been successfully posted.");
                    } else {
                        swalErrorNotification();
                    }
                },
                beforeSend: function() {
                    // Code to be executed before the request is sent
                    console.log('Request is about to be sent');
                },
                error: function(xhr, status, error) {
                    // Code to be executed if there is an error
                    console.error('Error:', error);
                },
                complete: function() {
                    // Code to be executed after the request is complete (success, error, or abort)
                    console.log('Request is complete');
                }
            });
        }
    });
</script>