<link rel="stylesheet" href="./../../common/css/forum.css" />
<div class="mx-4 my-0 mt-3">
    <div class="row">
        <div class="col-sm-12 col-lg-9 px-1 mb-2">
            <div class="card shadow-sm py-2 px-lg-5 px-sm-3" style="min-height: 320px">
                <div class="card-body py-2 px-md-2 mr-0" id="login-form">
                    <div id="card-form">
                        <div class="row my-1">
                            <div class="col-lg-12 col-md-12 col-sm-12">
                                <div class="row">
                                    <div class="col-lg-12 text-center">
                                        <h1 class="pb-2 forum-header text-center py-3">Learn about programming!</h1>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-4 text-center">
                                    </div>
                                    <div class="col-lg-4 text-center">
                                        <input type="button" class="btn btn-primary btn-block px-5" data-toggle="modal" data-target="#modal-add-question" id="button-ask-question" value="Ask a Question" />
                                    </div>
                                    <div class="col-lg-4 text-center">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row my-4">
                            <div class="col-lg-12 text-center">
                                <b class="text-center">OR</b>
                            </div>
                        </div>
                        <form autocomplete="off" id="form-search-question">
                            <div class="row">
                                <div class="col-lg-9 mb-3 mb-lg-0">
                                    <div class="autocomplete">
                                        <input type="text" class="form-control mr-3" name="input-search" placeholder="Search for a question?" id="input-search">
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <button type="submit" class="btn btn-primary btn-block px-4" value="Search" id="button-search">Search</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-12 col-lg-3 px-1 mb-2">
            <div class="card shadow-sm" style="min-height: 320px">
                <div class="card-body p-3">
                    <div id="card-form">
                        <h5 class="card-title font-weight-bold">Profile</h5>
                        <hr class="sidebar-divider sidebar-dark my-2">
                        <div id="profile-container">
                            <div class="row form-outline mb-3 pt-3">
                                <div class="col-4">
                                    <label class="form-label font-weight-bold" for="input-name">Name: </label>
                                </div>
                                <div class="col">
                                    <span class="fw-bolder" id="profile-name"></span>
                                </div>
                            </div>

                            <div class="row form-outline mb-3">
                                <div class="col-4">
                                    <label class="form-label font-weight-bold" for="input-email">Username: </label>
                                </div>
                                <div class="col">
                                    <span id="profile-user-name"></span>
                                </div>
                            </div>

                            <div id="student-profile" class="d-none">
                                <div class="row form-outline mb-3">
                                    <div class="col-4">
                                        <label class="form-label font-weight-bold" for="input-email">Year Level: </label>
                                    </div>
                                    <div class="col">
                                        <span id="profile-year-level"></span>
                                    </div>
                                </div>

                                <div class="row form-outline mb-3">
                                    <div class="col-4">
                                        <label class="form-label font-weight-bold" for="input-email">Major: </label>
                                    </div>
                                    <div class="col">
                                        <span id="profile-specialization"></span>
                                    </div>
                                </div>
                                <div class="row form-outline mb-3">
                                    <div class="col-4">
                                        <label class="form-label font-weight-bold" for="input-email">Rank: </label>
                                    </div>
                                    <div class="col">
                                        <span id="profile-ranking"></span>
                                    </div>
                                </div>
                            </div>

                            <div id="special-account-profile" class="d-none">
                                <div class="row form-outline mb-3">
                                    <div class="col-4">
                                        <label class="form-label font-weight-bold" for="input-job">Job: </label>
                                    </div>
                                    <div class="col">
                                        <span id="profile-job"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="profile-guest-container">
                            <div class="d-flex align-items-center justify-content-center h-75">
                                <div>
                                    <h5><b>Guest</b></h4>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9 px-1">
            <div class="card shadow-sm p-2 mb-5">
                <div class="card-body py-2 px-md-2">
                    <div id="card-form">
                        <div class="form-outline">
                            <div class="row">
                                <div class="col-lg-4">
                                    <h5 class="card-title font-weight-bold mt-1">Latest Question</h5>
                                </div>
                                <div class="col-lg-4 d-flex align-middle mb-3 mt-3 mb-lg-0 mt-lg-0">
                                    <label class="form-label align-middle mt-2 mr-2" for="input-scan">Subject: </label>
                                    <select class="form-control" class="dropdown" id="input-subject-filter">
                                        <option value="-1" selected>All</option>
                                    </select>
                                </div>
                                <div class="col-lg-4 d-flex">
                                    <label class="form-label mt-2 mr-2" for="input-scan">Status: </label>
                                    <select class="form-control ml-sm-2" class="dropdown" id="input-status-filter">
                                        <option value="-1" selected>All</option>
                                        <option value="1">Unanswered</option>
                                        <option value="2">Answered</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="sidebar-divider my-lg-2 my-4">
                            <div class="vertical-scrollable">
                                <div id="container-question"></div>
                                <div class="row">
                                    <div class="col text-center my-2">
                                        <input type="button" value="Load More" id="load-more-question" class="btn btn-primary btn-sm" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 px-lg-1 px-md-1 px-0 mb-4">
            <div class="card shadow-sm p-2">
                <div class="card-body py-2 px-md-2 px-lg-2 px-0" id="login-form">
                    <div id="card-form">
                        <div class="row">
                            <div class="col-lg-6">
                                <h5 class="card-title font-weight-bold mt-1">Ranking</h5>
                            </div>
                            <div class="col-lg-6">
                                <select name="" class="form-control" id="ranking-filter">
                                    <option value="-1">All</option>
                                    <option value="1" selected>Student</option>
                                    <option value="0">Professional</option>
                                </select>
                            </div>
                        </div>
                        <hr class="sidebar-divider my-2">
                        <div id="container-ranking"></div>
                        <div class="row text-center">
                            <div class="col text-center">
                                <a href="" id="load-more-ranking" class="btn btn-primary btn-sm">Load More</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-add-question" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ask a Question</h5>
            </div>
            <form id="form-add-question" class="needs-validation container">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-lg-1 d-flex align-middle text-center">
                            <label class="form-label align-middle pr-2 pt-2" for="input-">Title</label>
                        </div>
                        <div class="col">
                            <input type="text" id="input-new-question-title" class="form-control" placeholder="Enter title" required/>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-lg-1">
                            <label class="form-label align-middle pr-2 pt-2" for="input-scan">Subject</label>
                        </div>
                        <div class="col-lg-5">
                            <select class="form-control dropdown" id="input-new-question-subject" required>
                                <option value="" selected>--Please Select--</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-outline mb-3 ml-3 mt-3 mr-3">
                        <div class="w-100">
                            <div class="row row-editor">
                                <div class="editor-container">
                                    <div class="editor">
                                        <h5>Description:</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="button-close">Close</button>
                    <button type="submit" class="btn btn-primary">POST</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="./../../common/ckeditor/script.js"></script>
<script>
    $(document).ready(function() {
        var subjectList = new Array;
        var limit = 10;
        var rankingLimit = 10;
        var listOfFAQ = [];
        var autoCompleteXHR;
        getSubjectList();
        getLatestQuestion(-1, -1, limit, "");
        getUserProfile();
        populateRanking(rankingLimit);
        getFAQ();

        $("#ranking-filter").on("change", function() {
            populateRanking(rankingLimit);
        });

        function populateRanking(rankingLimit) {
            var filter = $("#ranking-filter").val();
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-ranking-list',
                    limit: rankingLimit,
                    filter: filter
                },
                cache: false,
                success: function(dataResult) {
                    var rankingList = "";
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        dataResult.rankingList.forEach(rank => {

                            if (rank.studentInformation == null) {
                                var picture = rank.professionalInformation['picture'];
                                if (picture == "") {
                                    picture = "./../../resource/profile/default.svg";
                                } else {
                                    picture = "./../../resource/profile/" + picture;
                                }
                                rankingList += populateProfessionalRankingRow(
                                    picture,
                                    rank.professionalInformation['userName'],
                                    rank.professionalInformation['job'],
                                    rank['rank'],
                                    rank['rating']
                                );
                            } else {
                                var picture = rank.studentInformation['picture'];
                                if (picture == "") {
                                    picture = "./../../resource/profile/default.svg";
                                } else {
                                    picture = "./../../resource/profile/" + picture;
                                }
                                rankingList += populateRankingRow(
                                    picture,
                                    rank.studentInformation['username'],
                                    rank.studentInformation['specialization'],
                                    getYearLevel(rank.studentInformation['yearLevel']),
                                    rank['rank'],
                                    rank['rating']
                                );
                            }
                        });
                    } else {
                        rankingList = populateEmptyRow();
                    }
                    $("#container-ranking").html(rankingList);
                }
            });
        }

        function getFAQ() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-faq'
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        const faqList = [];
                        dataResult.faqList.forEach(faq => {
                            faqList.push(faq.title);
                        });

                        listOfFAQ = faqList;
                        $("#input-search").autocomplete({
                            source: faqList,
                            minLength: 0
                        }).bind('focus', function() {
                            $("#input-search").autocomplete("search");
                        });
                    }
                }
            });
        }

        $("#input-search").on("keyup", function() {
            if ($(this).val() == "") {
                $("#input-search").autocomplete({
                    source: listOfFAQ,
                    minLength: 0
                });
                return;
            }
            if (autoCompleteXHR != null) {
                autoCompleteXHR.abort();
            }
            autoCompleteXHR = $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'search-faq',
                    search: $(this).val()
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        const faqList = [];
                        dataResult.faqList.forEach(faq => {
                            faqList.push(faq.title);
                            console.log(faqList);
                        });

                        $("#input-search").autocomplete({
                            source: faqList
                        });
                    }
                }
            });
        });

        $("#load-more-ranking").click(function(event) {
            event.preventDefault();
            rankingLimit += 10;
            populateRanking(rankingLimit);
        });

        function getUserProfile() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-user-profile'
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {

                        $("#profile-container").removeClass("d-none");
                        $("#profile-guest-container").addClass("d-none");

                        if (dataResult.userType == "1") {
                            $("#profile-name").html(dataResult.studentInformation.name);
                            $("#profile-user-name").html(dataResult.studentInformation.username);
                            $("#student-profile").removeClass("d-none");
                            $("#special-account-profile").addClass("d-none");
                            var rank = dataResult.studentInformation.ranking.rank;
                            var rating = dataResult.studentInformation.ranking.rating;
                            if (rank == null) {
                                rank = "Unranked";
                            }

                            if (rating == null) {
                                rating = 0;
                            }

                            $("#profile-year-level").html(dataResult.studentInformation.yearLevel);
                            $("#profile-specialization").html(dataResult.studentInformation.specialization);
                            $("#profile-ranking").html(`${rank} (${rating} Likes)`);
                        } else if (dataResult.userType == "3") {
                            $("#profile-name").html(dataResult.specialAccountInformation.name);
                            $("#profile-user-name").html(dataResult.specialAccountInformation.userName);
                            $("#student-profile").addClass("d-none");
                            $("#special-account-profile").removeClass("d-none");
                            $("#profile-job").html(dataResult.specialAccountInformation.job);
                        } else if (dataResult.userType == "4") {
                            $("#profile-container").addClass("d-none");
                            $("#profile-guest-container").removeClass("d-none");
                            $("#button-ask-question").attr("disabled", true);
                        }
                    }
                }
            });
        }

        function getSubjectList() {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-active-subject-list'
                },
                cache: false,
                success: function(dataResult) {
                    var subjectOptions = "";
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        subjectList = dataResult.subjectList;
                        dataResult.subjectList.forEach(subject => {
                            subjectOptions += "<option value='" + subject['subjectID'] + "'>" + subject['subject'] + "</option>";
                        });
                    }
                    $("#input-new-question-subject").html($("#input-new-question-subject").html() + subjectOptions);
                    $("#input-subject-filter").html($("#input-subject-filter").html() + subjectOptions);
                }
            });
        }

        function getLatestQuestion(subject, status, limit, search) {
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'retrieve-latest-question-list',
                    subject: subject,
                    status: status,
                    limit: limit,
                    search: search
                },
                cache: false,
                success: function(dataResult) {
                    var questionList = "";
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        dataResult.questionList.forEach(question => {
                            var picture = question['picture'];
                            var status;
                            var description = question['description'];
                            var subjectName = getSubjectName(question['subjectID']);
                            if (picture == "") {
                                picture = "./../../resource/profile/default.svg";
                            } else {
                                picture = "./../../resource/profile/" + picture;
                            }

                            if (question['status'] == 1) {
                                status = "<span class='border border-danger status-danger rounded p-1 '>Unanswered</span>";
                            } else if (question['status'] == 2) {
                                status = "<span class='border border-success status-success rounded p-1 '>Answered</span>";
                            }

                            var questionID = question['questionID'];

                            if (description.length > 225) {
                                description = description.substring(0, 225);
                                description += ` <a href="?id=${questionID}#main-forum" class="button-select-question"> see more...</a>`;
                            }
                            questionList += populateQuestionRow(questionID, picture, question['name'], status, question['creationDateTime'], subjectName, question['title'], description);
                        });
                    } else {
                        questionList = populateEmptyRow();
                    }
                    $("#container-question").html(questionList);

                    $(".button-select-question").on('click', function(event) {
                        $("#main-container").load('./form-main-forum.html');
                    });
                }
            });
        }

        function getSubjectName(subjectID) {
            var subjectName = "";
            subjectList.forEach(subject => {
                if (subjectID == subject['subjectID']) {
                    subjectName = subject['subject'];
                    return;
                }
            });
            return subjectName;
        }

        $("#input-status-filter").change(function() {
            getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, "");
        });

        $("#input-subject-filter").change(function() {
            getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, "");
        });

        $("#load-more-question").click(function() {
            limit += 10;
            if ($("#input-search").val().length > 0) {
                getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, $("#input-search").val());
            } else {
                getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, "");
            }
        });

        $("#form-search-question").on('submit', function(event) {
            event.preventDefault();
            if ($("#input-search").val().length > 0) {
                getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, $("#input-search").val());
            } else {
                getLatestQuestion($("#input-subject-filter").val(), $("#input-status-filter").val(), limit, "");
            }
        });

        $("#form-add-question").on("submit", function(event) {
            event.preventDefault();
            var title = $("#input-new-question-title").val();
            var subject = $("#input-new-question-subject").val();
            $.ajax({
                url: "../../common/db.php",
                type: "POST",
                data: {
                    action: 'save-question',
                    title: title,
                    description: window.editor.getData(),
                    subject: subject
                },
                cache: false,
                success: function(dataResult) {
                    var dataResult = JSON.parse(dataResult);
                    if (dataResult.statusCode == 200) {
                        getLatestQuestion(-1, -1, limit, "");
                        $("#modal-add-question").modal('toggle');
                        alert("Your question has been successfully posted!");
                    } else {
                        alert("Unable to post the question, please try again later!");
                    }
                }
            });
        });

        $('#modal-add-question').on('hidden.bs.modal', function() {
            $("#input-new-question-title").val("");
            $("#input-new-question-subject").val("").change();
            window.editor.setData(`<p>Description:</p><p><br><br><br><br data-cke-filler="true"></p>`);
        });
    });
</script>